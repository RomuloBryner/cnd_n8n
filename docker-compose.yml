version: '3.8'

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: cnd_n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      # Configuración básica de n8n
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-admin123}
      
      # URL pública de n8n (cambiar si usas dominio)
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678/}
      
      # Configuración de base de datos SQLite (persistente)
      - DB_TYPE=sqlite
      - DB_SQLITE_DATABASE=/home/node/.n8n/database.sqlite
      
      # Timezone
      - GENERIC_TIMEZONE=America/Santo_Domingo
      - TZ=America/Santo_Domingo
      
      # Configuración de ejecución
      - N8N_PAYLOAD_SIZE_MAX=16
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true
      
      # Seguridad
      - N8N_SECURE_COOKIE=false
      
      # Variables de entorno para WhatsApp API
      - WA_API_KEY=${WA_API_KEY}
      - WA_PHONE_NUMBER_ID=${WA_PHONE_NUMBER_ID:-848478885021265}
      
      # Variables de Strapi Backend
      - STRAPI_URL=${STRAPI_URL:-http://host.docker.internal:1337}
      - STRAPI_TOKEN=${STRAPI_TOKEN:-7853e2cdbbee30cf852855174eb9e7714cee7af46db90dcfc5cac9e4ae3b815f73f3fa93809a511329bcb2e61b36f3cb595f4d960f34ba9c707a3cabee8fb5cf171d4d90ca2b789db261bfac703e5d6001fba1cfc23c3e80bf26d550a5385de9564513cee4e6f4c38582ab6968aa3e1a46135e3476f514f6aa63b89b4c7fdb11}
    
    volumes:
      # Persistir datos de n8n
      - n8n_data:/home/node/.n8n
      
      # Montar workflows (opcional - para backup)
      - ./workflows:/home/node/.n8n/workflows
      
      # Montar archivo de workflow inicial
      - ./CND Whatsapp API.json:/home/node/.n8n/import/CND_Whatsapp_API.json:ro
    
    extra_hosts:
      # Permite a Docker acceder a localhost de la máquina host
      - "host.docker.internal:host-gateway"
    
    networks:
      - n8n_network

volumes:
  n8n_data:
    driver: local

networks:
  n8n_network:
    driver: bridge

